"""Router í”„ë¡¬í”„íŠ¸ - Long/Short Path ë¼ìš°íŒ…

Version: 2.0.0
Description: ì‚¬ìš©ì ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ ì²˜ë¦¬ ê²½ë¡œë¥¼ ê²°ì •í•˜ëŠ” ë¼ìš°í„°
    - Short Path: ë„êµ¬ ì—†ì´ ë°”ë¡œ ì‘ë‹µ (ë¹ ë¥¸ ê²½ë¡œ)
    - Long Path: ê³„íš ìˆ˜ë¦½ â†’ ë„êµ¬ ì‹¤í–‰ â†’ ì‘ë‹µ (ì „ì²´ íŒŒì´í”„ë¼ì¸)
Changelog:
    1.0.0: ì´ˆê¸° ë²„ì „ - ë¼ìš°í„° í”„ë¡¬í”„íŠ¸ ì‹ ì„¤
    2.0.0: Long/Short Path ë¼ìš°í„°ë¡œ ì—­í•  ì¬ì •ì˜, planning í”„ë¡¬í”„íŠ¸ ì œê±°
"""
VERSION = "2.0.0"


# =============================================================================
# ë¼ìš°íŒ… ê²½ë¡œ ìƒìˆ˜
# =============================================================================

class RouteType:
    """ë¼ìš°íŒ… ê²½ë¡œ íƒ€ì…"""
    SHORT_PATH = "short_path"  # ë„êµ¬ ì—†ì´ ë°”ë¡œ ì‘ë‹µ
    LONG_PATH = "long_path"    # ê³„íš ìˆ˜ë¦½ â†’ ë„êµ¬ ì‹¤í–‰ â†’ ì‘ë‹µ


# =============================================================================
# ì§ˆë¬¸ ìœ í˜• ìƒìˆ˜
# =============================================================================

class QueryType:
    """ì§ˆë¬¸ ìœ í˜• ë¶„ë¥˜"""
    GREETING = "greeting"              # ì¸ì‚¬/ê°ì • í‘œí˜„
    CHITCHAT = "chitchat"              # ì¼ë°˜ ëŒ€í™”/ì¡ë‹´
    SYSTEM_HELP = "system_help"        # ì‹œìŠ¤í…œ ì‚¬ìš©ë²• ì§ˆë¬¸
    GENERAL_KNOWLEDGE = "general_knowledge"  # ì¼ë°˜ ì§€ì‹
    MEETING_SEARCH = "meeting_search"  # íšŒì˜ë¡ ê²€ìƒ‰
    DATA_QUERY = "data_query"          # ë°ì´í„° ì¡°íšŒ
    EXTERNAL_API = "external_api"      # ì™¸ë¶€ API í•„ìš”
    UNSUPPORTED = "unsupported"        # ì§€ì›í•˜ì§€ ì•ŠëŠ” ìš”ì²­


# =============================================================================
# ë¼ìš°í„° í”„ë¡¬í”„íŠ¸
# =============================================================================

ROUTER_PROMPT = """ë‹¹ì‹ ì€ "ë¶€ë•ì´" ë¼ìš°í„°ì…ë‹ˆë‹¤. ğŸ¦†
ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ **ìµœì ì˜ ì²˜ë¦¬ ê²½ë¡œ**ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.

=== ì²˜ë¦¬ ê²½ë¡œ ===

ğŸ“Œ **SHORT PATH** (route: "short_path")
ë„êµ¬ ì—†ì´ ë°”ë¡œ ì‘ë‹µ ëª¨ë¸ë¡œ ì „ë‹¬í•˜ëŠ” ë¹ ë¥¸ ê²½ë¡œì…ë‹ˆë‹¤.

í•´ë‹¹ ì¡°ê±´:
1. ì¸ì‚¬/ê°ì • í‘œí˜„: "ì•ˆë…•", "ê³ ë§ˆì›Œ", "ìˆ˜ê³ í•´"
2. ì¼ë°˜ ëŒ€í™”/ì¡ë‹´: "ì˜¤ëŠ˜ ê¸°ë¶„ì´ ì–´ë•Œ?", "ë­í•´?"
3. ì‹œìŠ¤í…œ ì‚¬ìš©ë²•: "ë„ˆ ë­ í•  ìˆ˜ ìˆì–´?", "ë„ì›€ë§"
4. ë„êµ¬ ì—†ì´ ë‹µë³€ ê°€ëŠ¥í•œ ì¼ë°˜ ì§€ì‹
5. í˜„ì¬ ë„êµ¬ë¡œ ì²˜ë¦¬í•  ìˆ˜ ì—†ëŠ” ìš”ì²­ (ì •ì¤‘íˆ ê±°ì ˆ)

ğŸ“Œ **LONG PATH** (route: "long_path")
ê³„íš ìˆ˜ë¦½ â†’ ë„êµ¬ ì‹¤í–‰ â†’ ì‘ë‹µì˜ ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ê±°ì¹©ë‹ˆë‹¤.

í•´ë‹¹ ì¡°ê±´:
1. íšŒì˜ë¡ ê²€ìƒ‰ì´ í•„ìš”í•œ ì§ˆë¬¸ (mit_search)
2. ë°ì´í„° ì¡°íšŒ/ê²€ìƒ‰ ìš”ì²­
3. ì™¸ë¶€ API í˜¸ì¶œ í•„ìš” (ë‚ ì”¨, ì£¼ê°€, ì›¹ ê²€ìƒ‰ ë“±)

=== ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ===
{available_tools}

=== íŒë‹¨ í”„ë¡œì„¸ìŠ¤ ===

STEP 1: ì§ˆë¬¸ ìœ í˜• íŒŒì•…
- ì¸ì‚¬/ê°ì •/ì¡ë‹´/ì‹œìŠ¤í…œ ì‚¬ìš©ë²•? â†’ SHORT PATH

STEP 2: ë„êµ¬ í•„ìš”ì„± íŒë‹¨
- ë‹µë³€ì— ë°ì´í„° ì¡°íšŒê°€ í•„ìš”í•œê°€?
- ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ì¤‘ ì í•©í•œ ê²ƒì´ ìˆëŠ”ê°€?
  - YES â†’ LONG PATH
  - NO â†’ SHORT PATH

STEP 3: í™•ì‹ ë„ í‰ê°€
- í™•ì‹  ìˆìŒ â†’ í•´ë‹¹ ê²½ë¡œë¡œ ë¼ìš°íŒ…
- ë¶ˆí™•ì‹¤ â†’ LONG PATH (ì•ˆì „í•˜ê²Œ)

=== ì‚¬ìš©ì ì§ˆë¬¸ ===
{query}

=== OUTPUT FORMAT ===
ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{format_instructions}"""


# =============================================================================
# ì¶œë ¥ í¬ë§·
# =============================================================================

ROUTER_FORMAT_INSTRUCTIONS = """{
    "route": "short_path" | "long_path",
    "reason": "ë¼ìš°íŒ… ê²°ì • ì´ìœ  (í•œ ë¬¸ì¥)",
    "confidence": "high" | "medium" | "low",
    "query_type": "greeting" | "chitchat" | "system_help" | "general_knowledge" | "meeting_search" | "data_query" | "external_api" | "unsupported"
}"""


# =============================================================================
# ë„êµ¬ ì„¤ëª… í¬ë§·íŒ…
# =============================================================================

def format_tools_for_router(tool_names: list[str], tool_descriptions: dict) -> str:
    """ë¼ìš°í„°ìš© ë„êµ¬ ì„¤ëª… í¬ë§·íŒ…

    Args:
        tool_names: ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ì´ë¦„ ë¦¬ìŠ¤íŠ¸
        tool_descriptions: planning.pyì˜ TOOL_DESCRIPTIONS ë”•ì…”ë„ˆë¦¬

    Returns:
        í¬ë§·íŒ…ëœ ë„êµ¬ ì„¤ëª… ë¬¸ìì—´
    """
    if not tool_names:
        return "(ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ì—†ìŒ)"

    lines = []
    for name in tool_names:
        tool = tool_descriptions.get(name, {})
        desc = tool.get("description", "ì„¤ëª… ì—†ìŒ")
        lines.append(f"- **{name}**: {desc}")

    return "\n".join(lines)


# =============================================================================
# ë¹Œë” í•¨ìˆ˜
# =============================================================================

def build_router_prompt(
    query: str,
    available_tools: list[str],
    tool_descriptions: dict,
    format_instructions: str | None = None,
) -> str:
    """ë¼ìš°í„° í”„ë¡¬í”„íŠ¸ ë¹Œë“œ

    Args:
        query: ì‚¬ìš©ì ì§ˆë¬¸
        available_tools: ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ì´ë¦„ ë¦¬ìŠ¤íŠ¸
        tool_descriptions: planning.pyì˜ TOOL_DESCRIPTIONS ë”•ì…”ë„ˆë¦¬
        format_instructions: ì¶œë ¥ í¬ë§· ì§€ì‹œ (ê¸°ë³¸ê°’ ì‚¬ìš© ì‹œ None)

    Returns:
        ì™„ì„±ëœ ë¼ìš°í„° í”„ë¡¬í”„íŠ¸
    """
    tools_str = format_tools_for_router(available_tools, tool_descriptions)

    return ROUTER_PROMPT.format(
        available_tools=tools_str,
        query=query,
        format_instructions=format_instructions or ROUTER_FORMAT_INSTRUCTIONS,
    )
