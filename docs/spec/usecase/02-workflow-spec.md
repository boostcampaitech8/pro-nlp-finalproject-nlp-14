# MIT 워크플로우 명세 (Workflow Spec)

## 범위

이 문서는 주요 프로세스의 흐름과 상태 전이를 정의한다.

---

## WF-001: 회의 -> GT 업데이트 플로우

### 전체 흐름

```
┌──────────────────────────────────────────────────────────────────────┐
│                    회의 -> GT 업데이트 워크플로우                      │
└──────────────────────────────────────────────────────────────────────┘

[회의 시작]
     │
     ▼
┌─────────────┐
│  scheduled  │ Meeting.status
└──────┬──────┘
       │ startMeeting()
       │ [UC-003]
       ▼
┌─────────────┐     ┌──────────────────────────────────┐
│   ongoing   │────▶│ Branch 생성 (GT 기준 파생)        │
└──────┬──────┘     │ - base_gt_version 기록           │
       │            └──────────────────────────────────┘
       │                        │
       │                        ▼
       │              ┌──────────────────────────────────┐
       │              │ 실시간 처리                       │
       │              │ - VAD: 발화 감지                  │
       │              │ - STT: 실시간 텍스트 변환         │
       │              │ - Recording: 서버 녹음           │
       │              │ - Agent: 실시간 지원              │
       │              └──────────────────────────────────┘
       │
       │ endMeeting()
       │ [UC-004]
       ▼
┌─────────────┐     ┌──────────────────────────────────┐
│  completed  │────▶│ 후처리 (비동기)                   │
└──────┬──────┘     │ 1. Recording 파일 저장           │
       │            │ 2. Transcript 생성 (정제 STT)     │
       │            │ 3. Minutes 초안 생성 (Agent)      │
       │            └──────────────────────────────────┘
       │                        │
       │                        ▼
       │              ┌──────────────────────────────────┐
       │              │ Agent가 PR 자동 오픈             │
       │              │ - 리뷰어 자동 지정 [BR-009]      │
       │              │ - 팀원 알림                       │
       │              └──────────────────────────────────┘
       │
       │ PR 생성 완료
       ▼
┌─────────────┐     ┌──────────────────────────────────┐
│  in_review  │────▶│ 리뷰 프로세스                     │
└──────┬──────┘     │ - Comment/Suggestion 추가        │
       │            │ - Agent가 GT 대조 지원            │
       │            │ - Discussion                     │
       │            └──────────────────────────────────┘
       │
       │ merge() [UC-008]
       │ (approval 조건 충족 시)
       ▼
┌─────────────┐     ┌──────────────────────────────────┐
│  confirmed  │────▶│ GT(main) 업데이트                 │
└─────────────┘     │ - Decision 상태 파생 갱신         │
                    │ - 변경 이력 영구 보존             │
                    │ - Branch 상태: merged             │
                    │ - 팀원 알림                       │
                    └──────────────────────────────────┘
```

### 상태 전이 테이블

| 현재 상태 | 이벤트 | 다음 상태 | 트리거 | 조건 |
|-----------|--------|-----------|--------|------|
| scheduled | startMeeting | ongoing | Host | - |
| scheduled | cancelMeeting | cancelled | Host | - |
| ongoing | endMeeting | completed | Host | - |
| ongoing | cancelMeeting | cancelled | Host | - |
| completed | PR 생성 | in_review | System(Agent) | Transcript 생성 완료 |
| in_review | merge | confirmed | User/Agent | Approval 조건 충족 |
| in_review | closePR | completed | Host/Admin | - |

---

## WF-002: PR 리뷰 플로우

### 상태 다이어그램

```
                    ┌─────────────────────────┐
                    │         open            │
                    │    (PR 생성 직후)        │
                    └───────────┬─────────────┘
                                │
                    ┌───────────┼───────────┐
                    │           │           │
                    ▼           ▼           ▼
              ┌──────────┐ ┌──────────┐ ┌──────────┐
              │ comment  │ │ approve  │ │  close   │
              │ 추가     │ │ 추가     │ │ (취소)   │
              └────┬─────┘ └────┬─────┘ └────┬─────┘
                   │            │            │
                   │            ▼            │
                   │      ┌──────────┐       │
                   │      │필수 승인 │       │
                   │      │충족 여부 │       │
                   │      └────┬─────┘       │
                   │           │             │
                   │     ┌─────┴─────┐       │
                   │     │           │       │
                   │   Yes          No       │
                   │     │           │       │
                   │     ▼           │       │
                   │ ┌──────────┐    │       │
                   │ │ approved │    │       │
                   │ │(merge 가능)│  │       │
                   │ └────┬─────┘    │       │
                   │      │          │       │
                   │      ▼          │       │
                   │ ┌──────────┐    │       │
                   └▶│ in_review│◀───┘       │
                     │(리뷰 진행중)│           │
                     └────┬─────┘            │
                          │                  │
                    ┌─────┴─────┐            │
                    │           │            │
                  merge       close          │
                    │           │            │
                    ▼           ▼            ▼
              ┌──────────┐ ┌──────────────────────┐
              │  merged  │ │       closed         │
              │  (확정)  │ │   (취소/거부)         │
              └──────────┘ └──────────────────────┘
```

### PR 상태 정의

| 상태 | 설명 | 가능한 액션 |
|------|------|------------|
| open | PR 생성 직후 | comment, approve, close |
| in_review | 리뷰 진행 중 | comment, approve, close, merge(조건부) |
| approved | 필수 승인 충족 | merge, close |
| merged | GT 반영 완료 | - (최종 상태) |
| closed | 취소/거부 | - (최종 상태) |

---

## WF-003: Branch 생명주기

### 상태 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                      Branch 생명주기                             │
└─────────────────────────────────────────────────────────────────┘

     회의 시작 / 수동 생성
              │
              ▼
        ┌──────────┐
        │  active  │───────────────────────────────┐
        │ (활성)   │                               │
        └────┬─────┘                               │
             │                                     │
    ┌────────┼────────┐                           │
    │        │        │                           │
    ▼        ▼        ▼                           ▼
[Minutes  [Decision [PR 생성]                 [Meeting
 수정]     추가]     │                         취소]
    │        │       │                           │
    └────────┴───────┘                           │
             │                                    │
             ▼                                    │
        PR merge                                  │
             │                                    │
             ▼                                    ▼
        ┌──────────┐                        ┌──────────┐
        │  merged  │                        │  closed  │
        │ (병합됨) │                        │ (폐기)   │
        └──────────┘                        └──────────┘
             │                                    │
             │                                    │
             └────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  데이터 보존        │
                    │  (soft delete)   │
                    │  [BR-003]        │
                    └──────────────────┘
```

---

## WF-004: Decision 상태 파생 플로우

### 상태 파생 로직

```
┌─────────────────────────────────────────────────────────────────┐
│                    Decision 상태 파생                             │
└─────────────────────────────────────────────────────────────────┘

Decision 조회 요청
        │
        ▼
┌───────────────────────────────────────┐
│ 해당 Decision이 포함된 PR 조회         │
└─────────────────┬─────────────────────┘
                  │
        ┌─────────┴─────────┐
        │                   │
        ▼                   ▼
   PR 없음            PR 있음
        │                   │
        ▼                   ▼
    [draft]        ┌────────────────────┐
                   │   PR.status 확인   │
                   └─────────┬──────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
   open/in_review        merged               closed
        │                    │                    │
        ▼                    │                    ▼
    [draft]                  │               [outdated]
                             │               (폐기된 제안)
                             ▼
                   ┌──────────────────────┐
                   │ 같은 topic의 다른    │
                   │ Decision 존재 확인   │
                   └─────────┬────────────┘
                             │
                    ┌────────┴────────┐
                    │                 │
                    ▼                 ▼
           더 최신 있음          최신임
                    │                 │
                    ▼                 ▼
               [outdated]        [latest]
```

### 파생 규칙 (의사 코드)

```python
def derive_decision_status(decision):
    pr = get_pr_for_decision(decision)

    if pr is None:
        return 'draft'

    if pr.status in ['open', 'in_review', 'approved']:
        return 'draft'

    if pr.status == 'closed':
        return 'outdated'

    if pr.status == 'merged':
        # 같은 topic의 더 최신 decision이 있는지 확인
        newer_decisions = get_decisions_for_topic(
            decision.topic,
            merged_after=pr.merged_at
        )
        if newer_decisions:
            return 'outdated'
        return 'latest'
```

---

## WF-005: Agent 요청 처리 플로우

### 처리 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                    Agent 요청 처리 플로우                           │
└─────────────────────────────────────────────────────────────────┘

사용자 요청 (음성/텍스트)
        │
        ▼
┌───────────────────────────────────────┐
│           STT (음성인 경우)              │
└─────────────────┬─────────────────────┘
                  │
                  ▼
┌───────────────────────────────────────┐
│           의도 분석 (Intent)            │
│   - 질문/명령/요청 구분                   │
│   - 대상 엔티티 식별                      │
└─────────────────┬─────────────────────┘
                  │
                  ▼
┌───────────────────────────────────────┐
│           도구 선택 (Tool Selection)    │
│   - mit_blame, mit_search, ...        │
│   - mcp_jira, mcp_slack, ...          │
└─────────────────┬─────────────────────┘
                  │
                  ▼
┌───────────────────────────────────────┐
│           도구 실행                     │
│   - 파라미터 추출                        │
│   - API 호출                           │
│   - 결과 수집                           │
└─────────────────┬─────────────────────┘
                  │
                  ▼
┌───────────────────────────────────────┐
│           응답 생성                     │
│   - 결과 정리                           │
│   - 자연어 변환                          │
└─────────────────┬─────────────────────┘
                  │
                  ▼
┌───────────────────────────────────────┐
│           응답 전달                      │
│   - 텍스트 출력                          │
│   - TTS (음성 출력, 선택적)               │
└───────────────────────────────────────┘
```

---

## 프로세스 규칙 요약

| 규칙 | 설명 | 참조 |
|------|------|------|
| 회의 중 merge 금지 | 회의 진행 중 PR merge 권장하지 않음 | BR-001 |
| Branch 자동 생성 | 회의 시작 시 Branch 자동 생성 | UC-003 |
| PR 자동 생성 | 회의 종료 후 Agent가 PR 자동 생성 | UC-004 |
| 상태 파생 | Decision 상태는 PR 상태에서 파생 | INV-002 |
| GT 불변성 | GT는 PR merge로만 변경 | INV-003 |

---

## 참조

- 유즈케이스: [usecase/01-usecase-specs.md](01-usecase-specs.md)
- 도메인 규칙: [domain/03-domain-rules.md](../domain/03-domain-rules.md)
- 비즈니스 규칙: [policy/01-business-rules.md](../policy/01-business-rules.md)
