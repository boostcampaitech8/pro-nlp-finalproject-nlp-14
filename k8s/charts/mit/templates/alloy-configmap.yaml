apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: {{ .Values.global.namespace }}
data:
  config.alloy: |
    // ===========================================
    // OTLP Receiver (애플리케이션에서 메트릭 수신)
    // ===========================================
    otelcol.receiver.otlp "default" {
      grpc {
        endpoint = "0.0.0.0:4317"
      }
      http {
        endpoint = "0.0.0.0:4318"
      }
      output {
        metrics = [otelcol.processor.batch.default.input]
        // TODO: Tempo 설치 후 traces 활성화
        // 1. Tempo helm chart 설치 (MinIO 백엔드 필요)
        // 2. 아래 traces output 주석 해제:
        //    traces = [otelcol.exporter.otlp.tempo.input]
        // 3. backend/app/core/telemetry.py, backend/worker/src/telemetry.py에서
        //    BatchSpanProcessor 주석 해제
      }
    }

    // TODO: Tempo 설치 후 주석 해제
    // otelcol.exporter.otlp "tempo" {
    //   client {
    //     endpoint = "tempo:4317"
    //     tls {
    //       insecure = true
    //     }
    //   }
    // }

    // ===========================================
    // Batch Processor (효율적 전송을 위한 배치 처리)
    // ===========================================
    otelcol.processor.batch "default" {
      timeout = "5s"
      send_batch_size = 1000
      output {
        metrics = [otelcol.exporter.prometheus.default.input]
      }
    }

    // ===========================================
    // Prometheus Remote Write (메트릭 → Prometheus)
    // ===========================================
    otelcol.exporter.prometheus "default" {
      forward_to = [prometheus.remote_write.default.receiver]
    }

    prometheus.remote_write "default" {
      endpoint {
        url = "http://prometheus-server:80/api/v1/write"
      }
    }

    // ===========================================
    // Kubernetes Pod 로그 수집
    // ===========================================

    // Kubernetes Pod 발견
    discovery.kubernetes "pods" {
      role = "pod"
      namespaces {
        names = ["{{ .Values.global.namespace }}"]
      }
    }

    // Pod 로그 relabel (필요한 라벨만 추출)
    discovery.relabel "pods" {
      targets = discovery.kubernetes.pods.targets

      // namespace 라벨
      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "namespace"
      }

      // pod 이름 라벨
      rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "pod"
      }

      // container 이름 라벨
      rule {
        source_labels = ["__meta_kubernetes_pod_container_name"]
        target_label  = "container"
      }

      // app 라벨 (있는 경우)
      rule {
        source_labels = ["__meta_kubernetes_pod_label_app"]
        target_label  = "app"
      }

      // 로그 경로 설정
      rule {
        source_labels = ["__meta_kubernetes_pod_uid", "__meta_kubernetes_pod_container_name"]
        separator     = "/"
        target_label  = "__path__"
        replacement   = "/var/log/pods/*$1/$2/*.log"
      }
    }

    // Pod 로그 수집
    loki.source.kubernetes "pods" {
      targets    = discovery.relabel.pods.output
      forward_to = [loki.process.pods.receiver]
    }

    // 로그 처리 (JSON 파싱 등)
    loki.process "pods" {
      forward_to = [loki.write.default.receiver]

      // JSON 로그 파싱 시도 (실패해도 무시)
      stage.json {
        expressions = {
          level   = "levelname",
          message = "message",
        }
      }

      // level 라벨 정규화
      stage.labels {
        values = {
          level = "",
        }
      }
    }

    // Loki로 로그 전송
    loki.write "default" {
      endpoint {
        url = "http://loki:3100/loki/api/v1/push"
      }
    }
