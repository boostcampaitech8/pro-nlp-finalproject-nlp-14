# Helmfile - 선언적 Helm 배포
# 사용: helmfile -e local apply / helmfile -e prod apply

repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: livekit
    url: https://helm.livekit.io
  - name: grafana
    url: https://grafana.github.io/helm-charts
  - name: prometheus-community
    url: https://prometheus-community.github.io/helm-charts

environments:
  local:
    values:
      - values/local.yaml.gotmpl
  prod:
    values:
      - values/prod.yaml.gotmpl

---
releases:
  # ===========================================
  # MIT 앱 (ConfigMap, Secret, Deployments)
  # ===========================================
  - name: mit
    labels:
      type: app
      svc: mit
    chart: ./charts/mit
    namespace: {{ .Values.global.namespace }}
    createNamespace: true
    values:
      - global: {{ .Values.global | toYaml | nindent 10 }}
        images: {{ .Values.images | toYaml | nindent 10 }}
        backend: {{ .Values.backend | toYaml | nindent 10 }}
        frontend: {{ .Values.frontend | toYaml | nindent 10 }}
        database: {{ .Values.database | toYaml | nindent 10 }}
        redis: {{ .Values.redis | toYaml | nindent 10 }}
        livekit: {{ .Values.livekit | toYaml | nindent 10 }}
        jwt: {{ .Values.jwt | toYaml | nindent 10 }}
        app: {{ .Values.app | toYaml | nindent 10 }}
        worker: {{ .Values.worker | toYaml | nindent 10 }}
        neo4j: {{ .Values.neo4j | toYaml | nindent 10 }}
        ncp: {{ .Values.ncp | toYaml | nindent 10 }}
        oauth: {{ .Values.oauth | toYaml | nindent 10 }}
        ingress: {{ .Values.ingress | toYaml | nindent 10 }}
        cloudflare: {{ .Values.cloudflare | toYaml | nindent 10 }}
        resources:
          backend: {{ .Values.resources.backend | toYaml | nindent 12 }}
          frontend: {{ .Values.resources.frontend | toYaml | nindent 12 }}
          worker: {{ .Values.resources.worker | toYaml | nindent 12 }}
          arqWorker: {{ .Values.resources.arqWorker | toYaml | nindent 12 }}

  # ===========================================
  # Redis
  # ===========================================
  - name: redis
    labels:
      type: infra
      svc: redis
    chart: bitnami/redis
    namespace: {{ .Values.global.namespace }}
    values:
      # 한 곳에서만 쓰이는 값 - 하드코딩
      - architecture: standalone
        auth:
          enabled: false
        replica:
          replicaCount: 0
        # 공유 값 - values에서 참조
        master:
          persistence:
            enabled: true
            size: {{ .Values.resources.redis.storage }}
          resources:
            requests: {{ .Values.resources.redis.requests | toYaml | nindent 14 }}
            limits: {{ .Values.resources.redis.limits | toYaml | nindent 14 }}
          service:
            type: ClusterIP

  # ===========================================
  # LiveKit
  # ===========================================
  - name: livekit
    labels:
      type: infra
      svc: livekit
    chart: livekit/livekit-server
    namespace: {{ .Values.global.namespace }}
    needs:
      - redis
    values:
      # 한 곳에서만 쓰이는 값 - 하드코딩
      - fullnameOverride: lk-server  # 'livekit'은 K8s 환경변수 LIVEKIT_PORT와 충돌
        deploymentStrategy:
          type: Recreate  # hostPort 사용으로 RollingUpdate 불가
        livekit:
          key_file: keys.yaml
          rtc:
            tcp_port: {{ .Values.livekit.rtc.tcpPort }}
            port_range_start: {{ .Values.livekit.rtc.portRangeStart }}
            port_range_end: {{ .Values.livekit.rtc.portRangeEnd }}
            use_external_ip: {{ .Values.livekit.rtc.useExternalIp }}
            {{- if .Values.livekit.rtc.nodeIp }}
            node_ip: {{ .Values.livekit.rtc.nodeIp }}
            {{- end }}
          logging:
            level: info
            json: false
          room:
            empty_timeout: 5
            max_participants: 8
          # 공유 값 - values에서 참조
          redis:
            address: "{{ .Values.redis.host }}:{{ .Values.redis.port }}"
          webhook:
            api_key: {{ .Values.livekit.apiKey }}
            urls:
              {{- range .Values.livekit.webhookUrls }}
              - "{{ . }}"
              {{- end }}
        # Secret 참조 (mit-secrets의 keys.yaml 필드)
        storeKeysInSecret:
          enabled: true
          existingSecret: mit-secrets
        service:
          type: ClusterIP
        turn:
          enabled: false
        resources:
          requests: {{ .Values.resources.livekit.requests | toYaml | nindent 12 }}
          limits: {{ .Values.resources.livekit.limits | toYaml | nindent 12 }}

  # ===========================================
  # Prometheus (Metrics 저장소)
  # ===========================================
  - name: prometheus
    labels:
      type: observability
      svc: prometheus
    chart: prometheus-community/prometheus
    namespace: {{ .Values.global.namespace }}
    values:
      - server:
          extraFlags:
            - web.enable-remote-write-receiver
          persistentVolume:
            enabled: true
            size: {{ .Values.observability.prometheus.storage | default "10Gi" }}
          resources:
            requests: {{ .Values.resources.prometheus.requests | toYaml | nindent 14 }}
            limits: {{ .Values.resources.prometheus.limits | toYaml | nindent 14 }}
        alertmanager:
          enabled: false
        prometheus-pushgateway:
          enabled: false
        kube-state-metrics:
          enabled: true
        prometheus-node-exporter:
          enabled: false

  # ===========================================
  # Loki (Logs 저장소)
  # ===========================================
  - name: loki
    labels:
      type: observability
      svc: loki
    chart: grafana/loki
    namespace: {{ .Values.global.namespace }}
    values:
      - deploymentMode: SingleBinary
        loki:
          auth_enabled: false
          commonConfig:
            replication_factor: 1
          storage:
            type: filesystem
          schemaConfig:
            configs:
              - from: "2024-01-01"
                store: tsdb
                object_store: filesystem
                schema: v13
                index:
                  prefix: index_
                  period: 24h
        # SimpleScalable 모드 컴포넌트 비활성화 (SingleBinary와 충돌 방지)
        read:
          replicas: 0
        write:
          replicas: 0
        backend:
          replicas: 0
        # SingleBinary 모드에서는 cache/gateway 불필요
        gateway:
          enabled: false
        chunksCache:
          enabled: false
        resultsCache:
          enabled: false
        singleBinary:
          replicas: 1
          persistence:
            enabled: true
            size: {{ .Values.observability.loki.storage | default "10Gi" }}
          resources:
            requests: {{ .Values.resources.loki.requests | toYaml | nindent 14 }}
            limits: {{ .Values.resources.loki.limits | toYaml | nindent 14 }}

  # ===========================================
  # Grafana Alloy (OpenTelemetry Collector + Log Collection)
  # ===========================================
  - name: alloy
    labels:
      type: observability
      svc: alloy
    chart: grafana/alloy
    namespace: {{ .Values.global.namespace }}
    needs:
      - prometheus
      - loki
    values:
      - alloy:
          configMap:
            create: false
            name: alloy-config
          extraPorts:
            - name: otlp-grpc
              port: 4317
              targetPort: 4317
              protocol: TCP
            - name: otlp-http
              port: 4318
              targetPort: 4318
              protocol: TCP
          mounts:
            # Pod 로그 수집을 위한 hostPath 마운트
            varlog: true
            dockercontainers: true
        controller:
          type: daemonset
        resources:
          requests: {{ .Values.resources.alloy.requests | toYaml | nindent 12 }}
          limits: {{ .Values.resources.alloy.limits | toYaml | nindent 12 }}

  # ===========================================
  # Grafana (Visualization)
  # ===========================================
  - name: grafana
    labels:
      type: observability
      svc: grafana
    chart: grafana/grafana
    namespace: {{ .Values.global.namespace }}
    needs:
      - prometheus
      - loki
    values:
      - persistence:
          enabled: true
          size: {{ .Values.observability.grafana.storage | default "5Gi" }}
        adminUser: admin
        adminPassword: {{ .Values.observability.grafana.adminPassword | default "admin" }}
        datasources:
          datasources.yaml:
            apiVersion: 1
            datasources:
              - name: Prometheus
                type: prometheus
                url: http://prometheus-server:80
                isDefault: true
              - name: Loki
                type: loki
                url: http://loki:3100
        resources:
          requests: {{ .Values.resources.grafana.requests | toYaml | nindent 12 }}
          limits: {{ .Values.resources.grafana.limits | toYaml | nindent 12 }}

