name: CI - Build & Push Images

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'packages/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'packages/**'

permissions:
  contents: write
  packages: write
  pull-requests: read
  actions: write  # repository-dispatchë¡œ CD workflow íŠ¸ë¦¬ê±°ì— í•„ìš”

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/teamatoi

jobs:
  # ë³€ê²½ëœ ì„œë¹„ìŠ¤ ê°ì§€
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      worker: ${{ steps.filter.outputs.worker }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - '!backend/worker/**'
            frontend:
              - 'frontend/**'
              - 'packages/**'
            worker:
              - 'backend/worker/**'

  # Backend ì´ë¯¸ì§€ ë¹Œë“œ
  build-backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/mit-backend
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Frontend ì´ë¯¸ì§€ ë¹Œë“œ
  build-frontend:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/mit-frontend
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./frontend/Dockerfile
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VITE_API_URL=/api/v1
            VITE_DEV_MODE=false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Worker ì´ë¯¸ì§€ ë¹Œë“œ
  build-worker:
    needs: changes
    if: needs.changes.outputs.worker == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/mit-worker
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./backend/worker
          file: ./backend/worker/Dockerfile
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================
  # CI ì„±ê³µ ì—¬ë¶€ (Branch Protectionìš©)
  # ===========================================
  ci-success:
    name: CI Success
    needs: [changes, build-backend, build-frontend, build-worker]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check build results
        run: |
          # ë¹Œë“œê°€ í•„ìš”í–ˆëŠ”ë° ì‹¤íŒ¨í•œ ê²½ìš° ì²´í¬
          if [ "${{ needs.changes.outputs.backend }}" == "true" ] && [ "${{ needs.build-backend.result }}" == "failure" ]; then
            echo "âŒ Backend build failed"
            exit 1
          fi
          if [ "${{ needs.changes.outputs.frontend }}" == "true" ] && [ "${{ needs.build-frontend.result }}" == "failure" ]; then
            echo "âŒ Frontend build failed"
            exit 1
          fi
          if [ "${{ needs.changes.outputs.worker }}" == "true" ] && [ "${{ needs.build-worker.result }}" == "failure" ]; then
            echo "âŒ Worker build failed"
            exit 1
          fi
          echo "âœ… All required builds passed"

  # ===========================================
  # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ (main push ì‹œì—ë§Œ)
  # ===========================================
  update-tags:
    needs: [changes, build-backend, build-frontend, build-worker]
    # ëª¨ë“  ë¹Œë“œê°€ ì„±ê³µí•˜ê±°ë‚˜ skipëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰ (ì‹¤íŒ¨ ì‹œ ë°°í¬ ì•ˆ í•¨)
    # Note: needs.*.resultëŠ” GitHub Actions ë²„ê·¸ë¡œ ì¸í•´ ëª…ì‹œì  ì²´í¬ í•„ìš” (actions/runner#1540)
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.changes.result == 'success' &&
      needs.build-backend.result != 'failure' &&
      needs.build-frontend.result != 'failure' &&
      needs.build-worker.result != 'failure' &&
      (needs.build-backend.result == 'success' ||
       needs.build-frontend.result == 'success' ||
       needs.build-worker.result == 'success')
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.update.outputs.updated }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update image tags
        id: update
        run: |
          # Short SHA (7ì) - docker/metadata-actionì˜ type=shaì™€ ë™ì¼
          SHA="${GITHUB_SHA:0:7}"
          UPDATED="false"

          # ë¹Œë“œëœ ì„œë¹„ìŠ¤ë§Œ SHA íƒœê·¸ë¡œ ì—…ë°ì´íŠ¸
          if [ "${{ needs.changes.outputs.backend }}" == "true" ] && [ "${{ needs.build-backend.result }}" == "success" ]; then
            yq -i '.backend = "'$SHA'"' k8s/image-tags.yaml
            UPDATED="true"
            echo "âœ… Backend tag updated to $SHA"
          fi

          if [ "${{ needs.changes.outputs.frontend }}" == "true" ] && [ "${{ needs.build-frontend.result }}" == "success" ]; then
            yq -i '.frontend = "'$SHA'"' k8s/image-tags.yaml
            UPDATED="true"
            echo "âœ… Frontend tag updated to $SHA"
          fi

          if [ "${{ needs.changes.outputs.worker }}" == "true" ] && [ "${{ needs.build-worker.result }}" == "success" ]; then
            yq -i '.worker = "'$SHA'"' k8s/image-tags.yaml
            UPDATED="true"
            echo "âœ… Worker tag updated to $SHA"
          fi

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "::notice::UPDATED=$UPDATED"
          echo "ğŸ“ Current image-tags.yaml:"
          cat k8s/image-tags.yaml

      - name: Commit and push
        if: steps.update.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/image-tags.yaml
          git commit -m "chore: update image tags to ${{ github.sha }} [skip ci]"
          git push

  # ===========================================
  # CD íŠ¸ë¦¬ê±° (ë°°í¬ ì›Œí¬í”Œë¡œìš° í˜¸ì¶œ)
  # ===========================================
  trigger-deploy:
    needs: [update-tags]
    if: needs.update-tags.outputs.updated == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger CD workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: deploy
          client-payload: '{"sha": "${{ github.sha }}", "ref": "${{ github.ref }}"}'
