# CD - Production Deployment Pipeline
#
# í•„ìš”í•œ GitHub Secrets:
#   PROD_SSH_HOST     - í”„ë¡œë•ì…˜ ì„œë²„ IP/í˜¸ìŠ¤íŠ¸ëª…
#   PROD_SSH_USER     - SSH ì‚¬ìš©ìžëª… (mit)
#   PROD_SSH_KEY      - SSH ê°œì¸í‚¤ (PEM í˜•ì‹)
#
# GitHub Environment ì„¤ì •:
#   Settings > Environments > "production" ìƒì„±
#   - Protection rules: Required reviewers (ì„ íƒ)
#   - Deployment branches: main only
#
# í”„ë¡œë•ì…˜ ì„œë²„ ì‚¬ì „ ì„¤ì •:
#   1. SSH í‚¤ ë“±ë¡: ~/.ssh/authorized_keysì— ê³µê°œí‚¤ ì¶”ê°€
#   2. Git ì €ìž¥ì†Œ í´ë¡ : /home/mit/mit
#   3. .env íŒŒì¼ ì„¤ì •: /home/mit/mit/.env
#   4. kubectl/helmfile ì„¤ì¹˜ ë° k3s í´ëŸ¬ìŠ¤í„° ì—°ê²°
#   5. GHCR ì‹œí¬ë¦¿ ì„¤ì •: ./k8s/scripts/deploy-prod.sh --setup-ghcr

name: CD - Deploy to Production

on:
  # CIì—ì„œ ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ í›„ ìžë™ íŠ¸ë¦¬ê±°
  repository_dispatch:
    types: [deploy]

  # ìˆ˜ë™ ë°°í¬
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
      skip_health_check:
        description: 'í—¬ìŠ¤ì²´í¬ ìŠ¤í‚µ'
        required: false
        default: false
        type: boolean

env:
  DEPLOY_PATH: /home/mit/mit  # í”„ë¡œë•ì…˜ ì„œë²„ì˜ í”„ë¡œì íŠ¸ ê²½ë¡œ

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.PROD_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        env:
          SSH_HOST: ${{ secrets.PROD_SSH_HOST }}
          SSH_USER: ${{ secrets.PROD_SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            set -e
            cd ${{ env.DEPLOY_PATH }}

            echo "ðŸ“¥ Pulling latest changes..."
            git fetch origin main
            git reset --hard origin/main

            echo "ðŸš€ Deploying to Kubernetes..."
            ./k8s/scripts/deploy-prod.sh

            echo "âœ… Deployment completed!"
          ENDSSH

      - name: Health Check
        if: ${{ !inputs.skip_health_check }}
        env:
          SSH_HOST: ${{ secrets.PROD_SSH_HOST }}
          SSH_USER: ${{ secrets.PROD_SSH_USER }}
        run: |
          echo "â³ Waiting for pods to be ready..."
          sleep 30

          ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            set -e
            cd ${{ env.DEPLOY_PATH }}

            echo "ðŸ” Checking deployment status..."
            kubectl rollout status deployment/backend -n mit --timeout=120s
            kubectl rollout status deployment/frontend -n mit --timeout=120s

            echo "ðŸ“Š Current pod status:"
            kubectl get pods -n mit

            echo "ðŸ–¼ï¸ Current images:"
            kubectl get deployment -n mit -o jsonpath='{range .items[*]}{.metadata.name}: {.spec.template.spec.containers[0].image}{"\n"}{end}'
          ENDSSH

      - name: Notify on Failure
        if: failure()
        env:
          SSH_HOST: ${{ secrets.PROD_SSH_HOST }}
          SSH_USER: ${{ secrets.PROD_SSH_USER }}
        run: |
          echo "âŒ Deployment failed! Checking logs..."
          ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} << 'ENDSSH' || true
            kubectl get pods -n mit
            kubectl describe pods -n mit --selector=app=backend | tail -50
          ENDSSH

  # ë°°í¬ ì™„ë£Œ ì•Œë¦¼ (ì„ íƒì )
  notify:
    name: Notify Deployment
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "ðŸ”— SHA: ${{ github.event.client_payload.sha || github.sha }}"
          else
            echo "âŒ Deployment failed!"
          fi
